<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>P√âPITE üíé - D√©nicheur de p√©pites</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { 
            background: #000; 
            color: white; 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            overflow-y: scroll; 
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            transition: background 0.3s, color 0.3s;
        }

        /* Mode clair */
        body.light-mode {
            background: #f5f5f5;
            color: #000;
        }

        body.light-mode .card {
            background: #fff;
            border-color: rgba(0,0,0,0.1);
        }

        body.light-mode .card.active {
            border-color: #facb15;
        }

        body.light-mode #filter-menu,
        body.light-mode .bg-zinc-900,
        body.light-mode .bg-zinc-800 {
            background: #e5e5e5 !important;
            color: #000;
        }

        body.light-mode .text-gray-400,
        body.light-mode .text-gray-500 {
            color: #666 !important;
        }

        body.light-mode .border-white\/10 {
            border-color: rgba(0,0,0,0.1) !important;
        }
        
        body::-webkit-scrollbar { display: none; }
        
        .brand-logo { 
            font-family: 'Inter', sans-serif; 
            font-weight: 900; 
            font-style: italic; 
            letter-spacing: -0.05em; 
        }
        
        .card-wrapper { 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            scroll-snap-align: center; 
            transition: opacity 0.4s ease, transform 0.4s ease, max-height 0.4s ease;
            overflow: hidden;
        }

        .card { 
            width: 90vw; 
            max-width: 380px; 
            height: 78vh; 
            background: #1c1c1e; 
            border-radius: 2.5rem; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s ease; 
        }

        .card.active { 
            border: 2px solid #facb15; 
            transform: scale(1.02); 
            box-shadow: 0 0 30px rgba(250, 203, 21, 0.15); 
        }
        
        .product-img { 
            height: 50%; 
            width: 100%; 
            object-fit: cover; 
            pointer-events: none; 
        }
        
        .product-info {
            padding: 20px;
            height: 50%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .promo-badge { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            background: #facb15; 
            color: black; 
            font-weight: 900; 
            padding: 5px 12px; 
            border-radius: 12px; 
            font-size: 0.9rem; 
            z-index: 10; 
        }

        .priority-badge {
            position: absolute;
            top: 20px;
            right: 70px;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 1.2rem;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .priority-high { background: rgba(239, 68, 68, 0.9); }
        .priority-medium { background: rgba(251, 191, 36, 0.9); }
        .priority-low { background: rgba(59, 130, 246, 0.9); }
        
        .share-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 50%;
            color: white;
            z-index: 10;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .share-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        
        /* Coeur animation Double Tap */
        .heart-tap {
            position: absolute; 
            top: 25%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0);
            color: #facb15; 
            font-size: 80px; 
            z-index: 20; 
            opacity: 0; 
            pointer-events: none;
        }
        
        .animate-heart { 
            animation: heartPop 0.6s ease-out; 
        }
        
        @keyframes heartPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        .btn-action { 
            flex: 1; 
            padding: 12px; 
            border-radius: 15px; 
            font-weight: 800; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            border: 1px solid;
            cursor: pointer;
        }
        
        .btn-action:focus-visible {
            outline: 2px solid #facb15;
            outline-offset: 2px;
        }
        
        .btn-nope { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ef4444; 
            border-color: #ef4444; 
        }
        
        .btn-like { 
            background: rgba(16, 185, 129, 0.1); 
            color: #10b981; 
            border-color: #10b981; 
        }
        
        .voted-like { 
            background: #10b981 !important; 
            color: white !important; 
        }
        
        #filter-menu { 
            display: none; 
            position: fixed; 
            top: 70px; 
            left: 20px; 
            right: 20px; 
            background: #18181b; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 1.5rem; 
            z-index: 150; 
            padding: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #saved-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 200; 
            overflow-y: auto; 
            padding: 20px; 
        }

        body.light-mode #saved-modal {
            background: rgba(245,245,245,0.98);
        }
        
        .grid-saved { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
            margin-top: 20px; 
        }

        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Badge notification */
        .badge-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #facb15, #f59e0b);
            color: black;
            padding: 30px;
            border-radius: 2rem;
            z-index: 300;
            text-align: center;
            box-shadow: 0 20px 60px rgba(250, 203, 21, 0.4);
            animation: badgePop 0.5s ease-out forwards;
        }

        @keyframes badgePop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Style profil */
        .style-tag {
            display: inline-block;
            background: rgba(250, 203, 21, 0.2);
            color: #facb15;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin: 2px;
        }

        /* Range slider custom */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: #3f3f46;
            height: 0.5rem;
            border-radius: 0.5rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #facb15;
            height: 1.5rem;
            width: 1.5rem;
            border-radius: 50%;
            margin-top: -0.5rem;
        }

        input[type="range"]::-moz-range-track {
            background: #3f3f46;
            height: 0.5rem;
            border-radius: 0.5rem;
        }

        input[type="range"]::-moz-range-thumb {
            background: #facb15;
            height: 1.5rem;
            width: 1.5rem;
            border-radius: 50%;
            border: none;
        }

        /* Boutons de tri */
        .sort-btn {
            background: rgba(250, 203, 21, 0.1);
            border: 1px solid rgba(250, 203, 21, 0.3);
            color: #facb15;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-btn.active {
            background: #facb15;
            color: black;
            border-color: #facb15;
        }

        .sort-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <div class="fixed top-0 left-0 w-full z-[100] bg-black/80 backdrop-blur-lg p-4 flex justify-between items-center border-b border-white/10">
        <h1 class="text-2xl brand-logo uppercase">P√â<span class="text-yellow-400">PITE</span> üíé</h1>
        <div class="flex gap-2">
            <button onclick="toggleTheme()" class="bg-zinc-800 p-2 rounded-full border border-white/10" aria-label="Changer de th√®me">
                <span id="theme-icon">üåô</span>
            </button>
            <button onclick="toggleFilterMenu()" class="bg-zinc-800 px-4 py-2 rounded-full text-[10px] font-black uppercase border border-white/10 flex items-center gap-2">
                <span>üîç</span> Filtres
            </button>
        </div>
    </div>

    <div id="filter-menu">
        <h3 class="text-xs font-black uppercase text-gray-500 mb-4 tracking-widest text-center">Filtres avanc√©s</h3>
        
        <!-- Recherche -->
        <div class="mb-6">
            <label class="text-xs font-bold uppercase text-gray-400 mb-2 block">üîç Rechercher</label>
            <input type="text" id="search-input" placeholder="Nom de l'article ou marque..." 
                   class="w-full bg-zinc-800 p-3 rounded-xl text-white border border-white/10 focus:border-yellow-400 outline-none"
                   oninput="searchProducts(this.value)">
        </div>

        <!-- Tri -->
        <div class="mb-6">
            <label class="text-xs font-bold uppercase text-gray-400 mb-2 block">üìä Trier par</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setSortOrder('price_asc')" id="sort-price-asc" class="sort-btn">
                    üí∞ Prix ‚Üë
                </button>
                <button onclick="setSortOrder('price_desc')" id="sort-price-desc" class="sort-btn">
                    üí∞ Prix ‚Üì
                </button>
                <button onclick="setSortOrder('discount_asc')" id="sort-discount-asc" class="sort-btn">
                    üî• Promo ‚Üë
                </button>
                <button onclick="setSortOrder('discount_desc')" id="sort-discount-desc" class="sort-btn active">
                    üî• Promo ‚Üì
                </button>
            </div>
        </div>

        <!-- Filtre r√©duction -->
        <div class="mb-6">
            <label class="text-xs font-bold uppercase text-gray-400 mb-2 block">
                üí∞ R√©duction minimum : <span id="reduction-value" class="text-yellow-400">30%</span>
            </label>
            <input type="range" min="20" max="80" value="30" step="10" 
                   id="reduction-slider" class="w-full accent-yellow-400"
                   oninput="updateReductionFilter(this.value)">
            <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                <span>20%</span>
                <span>80%</span>
            </div>
        </div>

        <!-- Filtre prix -->
        <div class="mb-6">
            <label class="text-xs font-bold uppercase text-gray-400 mb-2 block">üíµ Fourchette de prix</label>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="text-[10px] text-gray-500">Prix min</label>
                    <input type="number" id="prix-min" placeholder="0‚Ç¨" 
                           class="w-full bg-zinc-800 p-2 rounded-lg text-white border border-white/10 focus:border-yellow-400 outline-none">
                </div>
                <div class="flex-1">
                    <label class="text-[10px] text-gray-500">Prix max</label>
                    <input type="number" id="prix-max" placeholder="200‚Ç¨" 
                           class="w-full bg-zinc-800 p-2 rounded-lg text-white border border-white/10 focus:border-yellow-400 outline-none">
                </div>
            </div>
        </div>

        <!-- Marques -->
        <div class="mb-6">
            <label class="text-xs font-bold uppercase text-gray-400 mb-2 block">üè∑Ô∏è Marques</label>
            <div id="brands-container" class="grid grid-cols-2 gap-3 max-h-40 overflow-y-auto pr-2"></div>
        </div>

        <button onclick="applyFilters(event)" id="apply-filters-btn" class="w-full bg-yellow-400 text-black py-4 rounded-xl font-black uppercase text-xs">Appliquer les filtres</button>
        <button onclick="resetFilters()" class="w-full bg-transparent border border-gray-600 text-gray-400 py-3 rounded-xl font-bold uppercase text-xs mt-2">R√©initialiser</button>
    </div>

    <div class="fixed top-20 right-6 z-[100] flex flex-col items-end gap-3">
        <button onclick="undoLastAction()" aria-label="Annuler la derni√®re action" class="bg-zinc-900/90 border border-gray-500 p-3 rounded-full text-gray-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><polyline points="3 3 3 8 8 8"/></svg>
        </button>
        <div class="bg-zinc-900/90 border border-white/10 px-4 py-2 rounded-2xl flex items-center gap-3">
            <span class="text-white font-black text-xl" id="flow-count">0</span>
            <span class="text-[9px] font-bold uppercase leading-none text-gray-400">Restants</span>
        </div>
        <div onclick="toggleSavedList()" class="bg-zinc-900/90 border border-yellow-400 px-4 py-2 rounded-2xl flex items-center gap-3 cursor-pointer">
            <span class="text-yellow-400 font-black text-xl" id="pepites-count">0</span>
            <span class="text-[9px] font-bold uppercase leading-none text-yellow-400">Sauv√©s</span>
        </div>
    </div>

    <div id="main-container" class="mt-20"></div>

    <div id="saved-modal">
        <div class="flex justify-between items-center max-w-4xl mx-auto mb-4">
            <h2 class="text-3xl font-black italic uppercase">Mon <span class="text-yellow-400">Butin</span></h2>
            <button onclick="toggleSavedList()" class="text-4xl text-gray-400">&times;</button>
        </div>

        <!-- Profil style -->
        <div id="style-profile" class="max-w-4xl mx-auto mb-6 bg-gradient-to-r from-purple-900/30 to-pink-900/30 border border-purple-500/30 rounded-2xl p-6">
            <h3 class="text-xl font-black mb-3">‚ú® Ton Style</h3>
            <p class="text-sm text-gray-300 mb-3" id="style-description">Analyse en cours...</p>
            <div id="style-tags" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Recommandations -->
        <div id="recommendations-section" class="max-w-4xl mx-auto mb-6">
            <button onclick="showRecommendations()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl font-black uppercase text-sm flex items-center justify-center gap-2">
                <span>‚ú®</span> Voir les recommandations pour toi
            </button>
        </div>

        <div id="saved-grid" class="grid-saved max-w-4xl mx-auto"></div>
        <div class="flex justify-center mt-10 gap-4">
            <button onclick="showStats()" class="text-yellow-400 text-[10px] font-bold uppercase tracking-widest border border-yellow-400/30 px-6 py-2 rounded-full">üìä Statistiques</button>
            <button onclick="clearCache()" class="text-red-500 text-[10px] font-bold uppercase tracking-widest border border-red-500/30 px-6 py-2 rounded-full">R√©initialiser l'App</button>
        </div>
    </div>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let history = []; 
        let currentIndex = 0;
        let lastTap = 0;
        let touchStartX = 0;
        let scrollTimeout;
        let currentSort = 'discount_desc'; // Tri par d√©faut

        let likedIds = JSON.parse(localStorage.getItem('pepite_likes')) || [];
        let dislikedIds = JSON.parse(localStorage.getItem('pepite_dislikes')) || [];
        let priorities = JSON.parse(localStorage.getItem('priorities')) || {};
        let notes = JSON.parse(localStorage.getItem('notes')) || {};

        // Fonction de vibration
        function vibrate(pattern = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Th√®me
        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('theme-icon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }

        // Charger le th√®me au d√©marrage
        function loadTheme() {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        }

        // Fonction de tri
        function setSortOrder(order) {
            currentSort = order;
            
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`sort-${order.replace('_', '-')}`).classList.add('active');
            
            // R√©appliquer les filtres avec le nouveau tri
            applyFilters();
        }

        function sortProducts(products) {
            const sorted = [...products];
            
            switch(currentSort) {
                case 'price_asc':
                    sorted.sort((a, b) => {
                        const priceA = parseFloat(a.prix_actuel.replace('‚Ç¨', ''));
                        const priceB = parseFloat(b.prix_actuel.replace('‚Ç¨', ''));
                        return priceA - priceB;
                    });
                    break;
                    
                case 'price_desc':
                    sorted.sort((a, b) => {
                        const priceA = parseFloat(a.prix_actuel.replace('‚Ç¨', ''));
                        const priceB = parseFloat(b.prix_actuel.replace('‚Ç¨', ''));
                        return priceB - priceA;
                    });
                    break;
                    
                case 'discount_asc':
                    sorted.sort((a, b) => a.reduction_valeur - b.reduction_valeur);
                    break;
                    
                case 'discount_desc':
                default:
                    sorted.sort((a, b) => b.reduction_valeur - a.reduction_valeur);
                    break;
            }
            
            return sorted;
        }

        async function init() {
            loadTheme();
            
            try {
                const cached = sessionStorage.getItem('products_cache');
                if (cached) {
                    allProducts = JSON.parse(cached);
                    initBrands();
                    applyFilters();
                    return;
                }

                const response = await fetch('tinder_shopping_final.json?t=' + Date.now());
                allProducts = await response.json();
                
                sessionStorage.setItem('products_cache', JSON.stringify(allProducts));
                
                initBrands();
                applyFilters();
            } catch (e) { 
                console.error("Erreur JSON", e);
                document.getElementById('main-container').innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center text-red-500 px-10 text-center gap-4">
                        <span class="text-6xl">‚ö†Ô∏è</span>
                        <p class="italic">Erreur de chargement des produits</p>
                        <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-3 rounded-full font-bold">
                            R√©essayer
                        </button>
                    </div>
                `;
            }
        }

        function initBrands() {
            const marques = [...new Set(allProducts.map(p => p.marque))].sort();
            const container = document.getElementById('brands-container');
            container.innerHTML = '';
            marques.forEach(m => {
                container.innerHTML += `
                    <label class="flex items-center gap-2 bg-zinc-800 p-3 rounded-xl cursor-pointer hover:bg-zinc-700 transition-colors">
                        <input type="checkbox" value="${m}" class="brand-checkbox accent-yellow-400">
                        <span class="text-[10px] font-bold uppercase truncate">${m}</span>
                    </label>
                `;
            });
        }

        function toggleFilterMenu() {
            const menu = document.getElementById('filter-menu');
            menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        }

        function updateReductionFilter(value) {
            document.getElementById('reduction-value').textContent = value + '%';
        }

        function searchProducts(query) {
            // La recherche sera appliqu√©e dans applyFilters
        }

        function applyFilters(event) {
            const checkboxes = document.querySelectorAll('.brand-checkbox:checked');
            let selectedBrands = Array.from(checkboxes).map(cb => cb.value);
            
            // R√©cup√©rer les valeurs des filtres
            const minReduction = parseInt(document.getElementById('reduction-slider').value);
            const prixMin = parseFloat(document.getElementById('prix-min').value) || 0;
            const prixMax = parseFloat(document.getElementById('prix-max').value) || Infinity;
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            
            // Filtrer les produits
            let filtered = allProducts.filter(p => {
                // Filtre marque
                const isBrandMatch = selectedBrands.length === 0 || selectedBrands.includes(p.marque);
                
                // Filtre r√©duction
                const hasGoodDiscount = p.reduction_valeur >= minReduction;
                
                // Filtre prix
                const prix = parseFloat(p.prix_actuel.replace('‚Ç¨', ''));
                const isPriceMatch = prix >= prixMin && prix <= prixMax;
                
                // Filtre recherche
                const matchSearch = !searchQuery || 
                    p.nom.toLowerCase().includes(searchQuery) || 
                    p.marque.toLowerCase().includes(searchQuery);
                
                // Pas d√©j√† rejet√© OU lik√© (NOUVEAU: retirer les lik√©s du feed)
                const isNotProcessed = !dislikedIds.includes(String(p.id)) && !likedIds.includes(String(p.id));
                
                return isBrandMatch && hasGoodDiscount && isPriceMatch && matchSearch && isNotProcessed;
            });

            // Appliquer le tri
            filteredProducts = sortProducts(filtered);

            // Feedback visuel sur le bouton
            if (event) {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Appliqu√©';
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-yellow-400');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-green-500');
                    btn.classList.add('bg-yellow-400');
                }, 1500);
            }

            document.getElementById('filter-menu').style.display = 'none';
            render();
            window.scrollTo(0, 0);
            currentIndex = 0;
            updateCounts();
            updateActiveCard();
        }

        function resetFilters() {
            document.querySelectorAll('.brand-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('reduction-slider').value = 30;
            document.getElementById('reduction-value').textContent = '30%';
            document.getElementById('prix-min').value = '';
            document.getElementById('prix-max').value = '';
            document.getElementById('search-input').value = '';
            currentSort = 'discount_desc';
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sort-discount-desc').classList.add('active');
            applyFilters();
        }

        function render() {
            const container = document.getElementById('main-container');
            container.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center text-gray-500 px-10 text-center gap-4">
                        <span class="text-6xl">üò¢</span>
                        <p class="italic text-lg">Aucune p√©pite avec ces filtres</p>
                        <button onclick="resetFilters()" class="bg-yellow-400 text-black px-6 py-3 rounded-full font-bold uppercase text-sm">
                            R√©initialiser les filtres
                        </button>
                    </div>
                `;
                return;
            }

            filteredProducts.forEach((p, i) => {
                const isLiked = likedIds.includes(String(p.id));
                const priority = priorities[String(p.id)];
                const note = notes[String(p.id)];
                
                const wrapper = document.createElement('div');
                wrapper.className = "card-wrapper";
                wrapper.id = `wrapper-${i}`;
                wrapper.innerHTML = `
                    <div class="card" id="card-${i}" onclick="detectDoubleTap(event, ${i})">
                        <div class="heart-tap" id="heart-${i}">üíé</div>
                        <div class="promo-badge">${p.reduction_label || "-50%"}</div>
                        ${priority ? `<div class="priority-badge priority-${priority}">${priority === 'high' ? 'üî•' : priority === 'medium' ? '‚≠ê' : 'üíô'}</div>` : ''}
                        <button onclick="shareProduct(event, '${p.nom.replace(/'/g, "\\'")}', '${p.url}')" class="share-btn" aria-label="Partager ce produit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                        </button>
                        <img src="${p.image}" loading="lazy" class="product-img" referrerpolicy="no-referrer" alt="${p.nom}">
                        <div class="product-info">
                            <div>
                                <p class="text-yellow-400 font-bold uppercase text-[10px] mb-1">${p.marque}</p>
                                <h2 class="text-white text-xl font-bold leading-tight line-clamp-1">${p.nom}</h2>
                                <div class="mt-2">
                                    <span class="text-3xl font-black">${p.prix_actuel}</span>
                                    <span class="ml-2 text-sm text-gray-500 line-through">${p.prix_base}</span>
                                </div>
                                <p class="text-[9px] text-gray-400 mt-2 uppercase tracking-tighter">Tailles: ${p.tailles.join(', ')}</p>
                                ${note ? `<p class="text-xs text-yellow-400 italic mt-2 line-clamp-2">üìù "${note}"</p>` : ''}
                            </div>
                            <div class="flex gap-3 mt-4">
                                <button onclick="vote(${i}, 'nope')" class="btn-action btn-nope" aria-label="Rejeter ce produit">‚úñÔ∏è Bof</button>
                                <button onclick="vote(${i}, 'like')" id="btn-like-${i}" class="btn-action btn-like ${isLiked ? 'voted-like' : ''}" aria-label="${isLiked ? 'Produit sauvegard√©' : 'Sauvegarder ce produit'}">
                                    üíé ${isLiked ? 'Sauv√©' : 'P√©pite'}
                                </button>
                            </div>
                            <a href="${p.url}" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-white text-black py-4 rounded-2xl font-black text-xs uppercase mt-3">Saisir l'offre</a>
                        </div>
                    </div>
                `;
                container.appendChild(wrapper);
            });
        }

        function detectDoubleTap(e, index) {
            if (e.target.closest('button') || e.target.closest('a')) return;
            
            let now = new Date().getTime();
            let timesince = now - lastTap;
            if ((timesince < 300) && (timesince > 0)) {
                const heart = document.getElementById(`heart-${index}`);
                heart.classList.add('animate-heart');
                setTimeout(() => heart.classList.remove('animate-heart'), 600);
                vote(index, 'like');
            }
            lastTap = now;
        }

        function vote(index, type) {
            const product = filteredProducts[index];
            const pId = String(product.id);
            const wrapper = document.getElementById(`wrapper-${index}`);

            if (type === 'like') {
                if (!likedIds.includes(pId)) {
                    likedIds.push(pId);
                    
                    // VIBRATION au moment du like
                    vibrate([50, 30, 50]); // Pattern: vibrer 50ms, pause 30ms, vibrer 50ms
                    
                    confetti({ 
                        particleCount: 100, 
                        spread: 70, 
                        origin: { y: 0.6 }, 
                        colors: ['#facb15', '#ffffff'] 
                    });
                    checkBadges();
                    
                    // Animation de retrait du feed
                    wrapper.style.opacity = '0';
                    wrapper.style.transform = 'scale(0.8)';
                    wrapper.style.maxHeight = '0';
                    
                    setTimeout(() => {
                        filteredProducts.splice(index, 1);
                        render();
                        updateCounts();
                        updateActiveCard();
                    }, 400);
                    
                } else {
                    // Si d√©j√† lik√©, on le retire des likes (toggle)
                    likedIds = likedIds.filter(id => id !== pId);
                }
                localStorage.setItem('pepite_likes', JSON.stringify(likedIds));
                
            } else if (type === 'nope') {
                history.push({ index: index, data: product });
                dislikedIds.push(pId);
                localStorage.setItem('pepite_dislikes', JSON.stringify(dislikedIds));
                
                // Vibration l√©g√®re pour le rejet
                vibrate(30);
                
                wrapper.style.opacity = '0';
                wrapper.style.maxHeight = '0';
                
                setTimeout(() => {
                    filteredProducts.splice(index, 1);
                    render();
                    updateCounts();
                    updateActiveCard();
                }, 400);
            }
            updateCounts();
        }

        function undoLastAction() {
            if (history.length === 0) {
                alert('Rien √† annuler !');
                return;
            }
            
            const last = history.pop();
            
            dislikedIds = dislikedIds.filter(id => id !== String(last.data.id));
            localStorage.setItem('pepite_dislikes', JSON.stringify(dislikedIds));
            
            filteredProducts.splice(last.index, 0, last.data);
            render();
            updateCounts();
            
            setTimeout(() => {
                const target = document.getElementById(`wrapper-${last.index}`);
                if (target) target.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function updateCounts() { 
            document.getElementById('pepites-count').innerText = likedIds.length;
            document.getElementById('flow-count').innerText = filteredProducts.length;
        }

        // Fonction 9: Priorit√©s
        function setPriority(productId, priority) {
            priorities[String(productId)] = priority;
            localStorage.setItem('priorities', JSON.stringify(priorities));
            vibrate(20); // Petite vibration de confirmation
            toggleSavedList();
            toggleSavedList(); // Refresh
        }

        // Fonction 9: Notes
        function addNote(productId) {
            const note = prompt('Ajoute une note personnelle :');
            if (note && note.trim()) {
                notes[String(productId)] = note.trim();
                localStorage.setItem('notes', JSON.stringify(notes));
                vibrate(20);
                toggleSavedList();
                toggleSavedList(); // Refresh
            }
        }

        function deleteNote(productId) {
            delete notes[String(productId)];
            localStorage.setItem('notes', JSON.stringify(notes));
            vibrate(20);
            toggleSavedList();
            toggleSavedList();
        }

        // Fonction 17: Recommandations
        function getRecommendations() {
            const saved = allProducts.filter(p => likedIds.includes(String(p.id)));
            
            if (saved.length === 0) {
                return [];
            }
            
            // Analyser les marques pr√©f√©r√©es
            const marqueFreq = {};
            saved.forEach(p => {
                marqueFreq[p.marque] = (marqueFreq[p.marque] || 0) + 1;
            });
            
            // Prix moyen
            const prixMoyen = saved.reduce((sum, p) => 
                sum + parseFloat(p.prix_actuel.replace('‚Ç¨', '')), 0
            ) / saved.length;
            
            // Recommander des produits similaires
            const recommendations = allProducts.filter(p => {
                const isSimilarBrand = marqueFreq[p.marque] > 0;
                const prix = parseFloat(p.prix_actuel.replace('‚Ç¨', ''));
                const isSimilarPrice = Math.abs(prix - prixMoyen) < 50;
                const notSeen = !dislikedIds.includes(String(p.id)) && !likedIds.includes(String(p.id));
                
                return isSimilarBrand && isSimilarPrice && notSeen;
            });
            
            // Trier par r√©duction
            return recommendations.sort((a, b) => b.reduction_valeur - a.reduction_valeur).slice(0, 10);
        }

        function showRecommendations() {
            const reco = getRecommendations();
            
            if (reco.length === 0) {
                alert('üí° Sauvegarde quelques p√©pites pour obtenir des recommandations personnalis√©es !');
                return;
            }
            
            vibrate(30);
            
            // Filtrer pour afficher uniquement les recommandations
            filteredProducts = reco;
            render();
            updateCounts();
            toggleSavedList(); // Fermer la modale
            window.scrollTo(0, 0);
            
            // Notification
            const notif = document.createElement('div');
            notif.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 bg-purple-500 text-white px-6 py-3 rounded-2xl font-bold z-[300] text-center';
            notif.textContent = `‚ú® ${reco.length} recommandations pour toi !`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // Fonction 18: D√©tection de style
        function detectStyle() {
            const saved = allProducts.filter(p => likedIds.includes(String(p.id)));
            
            if (saved.length === 0) {
                return {
                    keywords: [],
                    description: 'Sauvegarde des p√©pites pour d√©couvrir ton style !',
                    marquesPref: []
                };
            }
            
            // Analyser les noms pour d√©tecter des mots-cl√©s
            const keywords = {};
            saved.forEach(p => {
                const words = p.nom.toLowerCase()
                    .replace(/[^\w\s]/g, '')
                    .split(' ');
                words.forEach(word => {
                    if (word.length > 4) {
                        keywords[word] = (keywords[word] || 0) + 1;
                    }
                });
            });
            
            // Top 5 mots-cl√©s
            const topKeywords = Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([word]) => word);
            
            // Marques pr√©f√©r√©es
            const marques = {};
            saved.forEach(p => {
                marques[p.marque] = (marques[p.marque] || 0) + 1;
            });
            
            const topMarques = Object.entries(marques)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([marque]) => marque);
            
            return {
                keywords: topKeywords,
                description: `Tu aimes le style : ${topKeywords.slice(0, 3).join(', ')}`,
                marquesPref: topMarques
            };
        }

        function updateStyleProfile() {
            const style = detectStyle();
            
            document.getElementById('style-description').textContent = style.description;
            
            const tagsContainer = document.getElementById('style-tags');
            tagsContainer.innerHTML = '';
            
            style.keywords.forEach(keyword => {
                tagsContainer.innerHTML += `<span class="style-tag">#${keyword}</span>`;
            });
            
            if (style.marquesPref.length > 0) {
                tagsContainer.innerHTML += '<div class="w-full mt-2 pt-2 border-t border-white/10 text-xs text-gray-400">Marques favorites : ' + style.marquesPref.join(', ') + '</div>';
            }
        }

        // Badges
        const badges = {
            'first_like': { nom: 'üåü Premi√®re p√©pite', desc: 'Sauvegarde ton premier article', condition: () => likedIds.length >= 1 },
            'collector': { nom: 'üíé Collectionneur', desc: 'Sauvegarde 10 p√©pites', condition: () => likedIds.length >= 10 },
            'big_spender': { nom: 'üí∏ Gros budget', desc: 'Sauvegarde un article > 100‚Ç¨', condition: () => {
                const saved = allProducts.filter(p => likedIds.includes(String(p.id)));
                return saved.some(p => parseFloat(p.prix_actuel.replace('‚Ç¨', '')) > 100);
            }},
            'bargain_hunter': { nom: 'üéØ Chasseur de promos', desc: 'Trouve une promo > 60%', condition: () => {
                const saved = allProducts.filter(p => likedIds.includes(String(p.id)));
                return saved.some(p => p.reduction_valeur > 60);
            }},
            'swipe_master': { nom: 'üëÜ Swipe Master', desc: '√âvalue 50 produits', condition: () => {
                return (likedIds.length + dislikedIds.length) >= 50;
            }},
            'brand_lover': { nom: '‚ù§Ô∏è Fan de marque', desc: 'Sauvegarde 5 articles d\'une m√™me marque', condition: () => {
                const saved = allProducts.filter(p => likedIds.includes(String(p.id)));
                const marques = {};
                saved.forEach(p => {
                    marques[p.marque] = (marques[p.marque] || 0) + 1;
                });
                return Object.values(marques).some(count => count >= 5);
            }}
        };

        function checkBadges() {
            const earned = JSON.parse(localStorage.getItem('badges_earned')) || [];
            const newBadges = [];
            
            Object.entries(badges).forEach(([id, badge]) => {
                if (!earned.includes(id) && badge.condition()) {
                    newBadges.push(id);
                }
            });
            
            if (newBadges.length > 0) {
                earned.push(...newBadges);
                localStorage.setItem('badges_earned', JSON.stringify(earned));
                showBadgeNotification(newBadges[0]);
            }
        }

        function showBadgeNotification(badgeId) {
            const badge = badges[badgeId];
            const notif = document.createElement('div');
            notif.className = 'badge-notification';
            notif.innerHTML = `
                <div class="text-5xl mb-3">${badge.nom.split(' ')[0]}</div>
                <div class="text-xl font-black mb-2">${badge.nom.substring(2)}</div>
                <div class="text-sm opacity-80">${badge.desc}</div>
            `;
            document.body.appendChild(notif);
            
            vibrate([100, 50, 100, 50, 100]); // Vibration sp√©ciale pour les badges
            
            confetti({ 
                particleCount: 150, 
                spread: 100, 
                origin: { y: 0.5 },
                colors: ['#facb15', '#f59e0b', '#ffffff']
            });
            
            setTimeout(() => {
                notif.style.animation = 'badgePop 0.3s ease-out reverse';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function toggleSavedList() {
            const modal = document.getElementById('saved-modal');
            const grid = document.getElementById('saved-grid');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
            
            if (modal.style.display === 'block') {
                updateStyleProfile(); // Mettre √† jour le profil de style
                
                const savedItems = allProducts.filter(p => likedIds.includes(String(p.id)));
                
                // Trier par priorit√©
                savedItems.sort((a, b) => {
                    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                    const aPriority = priorities[String(a.id)] || 'none';
                    const bPriority = priorities[String(b.id)] || 'none';
                    
                    if (aPriority === bPriority) return 0;
                    if (aPriority === 'none') return 1;
                    if (bPriority === 'none') return -1;
                    return priorityOrder[aPriority] - priorityOrder[bPriority];
                });
                
                grid.innerHTML = savedItems.length ? '' : '<p class="col-span-full text-center text-gray-500 py-20 italic">Rien par ici... Double-tape sur un produit pour le sauvegarder ! üíé</p>';
                
                savedItems.forEach(p => {
                    const priority = priorities[String(p.id)];
                    const note = notes[String(p.id)];
                    
                    grid.innerHTML += `
                        <div class="bg-zinc-900 border border-white/5 p-3 rounded-3xl relative">
                            ${priority ? `<div class="absolute top-2 right-2 text-xl">${priority === 'high' ? 'üî•' : priority === 'medium' ? '‚≠ê' : 'üíô'}</div>` : ''}
                            <img src="${p.image}" loading="lazy" class="w-full h-32 object-cover rounded-2xl mb-3" referrerpolicy="no-referrer" alt="${p.nom}">
                            <p class="text-yellow-400 font-black text-[9px] uppercase mb-1">${p.marque}</p>
                            <h3 class="text-sm font-bold mb-1 line-clamp-2">${p.nom}</h3>
                            <span class="font-black text-sm">${p.prix_actuel}</span>
                            <span class="text-xs text-gray-500 line-through ml-1">${p.prix_base}</span>
                            
                            ${note ? `<p class="text-xs text-gray-400 italic mt-2 line-clamp-2">üìù "${note}"</p>` : ''}
                            
                            <!-- Priorit√©s -->
                            <div class="flex gap-1 mt-2">
                                <button onclick="setPriority('${p.id}', 'high')" class="flex-1 ${priority === 'high' ? 'bg-red-500' : 'bg-red-500/20'} text-red-500 py-1 rounded text-xs font-bold" title="Haute priorit√©">üî•</button>
                                <button onclick="setPriority('${p.id}', 'medium')" class="flex-1 ${priority === 'medium' ? 'bg-yellow-500' : 'bg-yellow-500/20'} text-yellow-500 py-1 rounded text-xs font-bold" title="Priorit√© moyenne">‚≠ê</button>
                                <button onclick="setPriority('${p.id}', 'low')" class="flex-1 ${priority === 'low' ? 'bg-blue-500' : 'bg-blue-500/20'} text-blue-500 py-1 rounded text-xs font-bold" title="Basse priorit√©">üíô</button>
                            </div>
                            
                            <div class="flex gap-2 mt-2">
                                <a href="${p.url}" target="_blank" rel="noopener noreferrer" class="flex-1 bg-white text-black py-2 rounded-lg text-[10px] text-center font-bold uppercase">üõí VOIR</a>
                                <button onclick="removeSaved('${p.id}')" class="bg-red-500/20 text-red-500 px-3 rounded-lg text-[10px] font-bold" aria-label="Retirer des favoris">üóëÔ∏è</button>
                            </div>
                            
                            <div class="flex gap-2 mt-2">
                                ${note ? 
                                    `<button onclick="deleteNote('${p.id}')" class="flex-1 text-gray-400 text-xs py-1 border border-gray-600 rounded">‚ùå Note</button>` :
                                    `<button onclick="addNote('${p.id}')" class="flex-1 text-gray-400 text-xs py-1 border border-gray-600 rounded">üìù Note</button>`
                                }
                            </div>
                        </div>`;
                });
            }
        }

        function removeSaved(productId) {
            likedIds = likedIds.filter(id => id !== String(productId));
            localStorage.setItem('pepite_likes', JSON.stringify(likedIds));
            
            // Supprimer aussi la priorit√© et la note
            delete priorities[String(productId)];
            delete notes[String(productId)];
            localStorage.setItem('priorities', JSON.stringify(priorities));
            localStorage.setItem('notes', JSON.stringify(notes));
            
            vibrate(30);
            updateCounts();
            
            // R√©appliquer les filtres pour que l'article r√©apparaisse dans le feed
            applyFilters();
            
            toggleSavedList();
            toggleSavedList();
        }

        function shareProduct(event, nom, url) {
            event.stopPropagation();
            
            if (navigator.share) {
                navigator.share({
                    title: `P√©pite trouv√©e : ${nom}`,
                    text: `Regarde cette p√©pite sur P√âPITE üíé`,
                    url: url
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    vibrate(20);
                    alert('‚úÖ Lien copi√© dans le presse-papier !');
                });
            }
        }

        function showStats() {
            const saved = allProducts.filter(p => likedIds.includes(String(p.id)));
            const total = likedIds.length + dislikedIds.length;
            const tauxAcceptation = total > 0 ? ((likedIds.length / total) * 100).toFixed(1) : 0;
            
            // Calculer √©conomies
            let totalEconomies = 0;
            saved.forEach(p => {
                const prixBase = parseFloat(p.prix_base.replace('‚Ç¨', ''));
                const prixActuel = parseFloat(p.prix_actuel.replace('‚Ç¨', ''));
                totalEconomies += (prixBase - prixActuel);
            });
            
            // Prix moyen
            const prixMoyen = saved.length > 0 ? 
                (saved.reduce((sum, p) => sum + parseFloat(p.prix_actuel.replace('‚Ç¨', '')), 0) / saved.length).toFixed(2) : 0;
            
            // R√©duction moyenne
            const reductionMoy = saved.length > 0 ?
                (saved.reduce((sum, p) => sum + p.reduction_valeur, 0) / saved.length).toFixed(0) : 0;
            
            // Marque pr√©f√©r√©e
            const marques = {};
            saved.forEach(p => {
                marques[p.marque] = (marques[p.marque] || 0) + 1;
            });
            const marquePref = Object.keys(marques).length > 0 ?
                Object.keys(marques).reduce((a, b) => marques[a] > marques[b] ? a : b) : 'Aucune';
            
            // Badges gagn√©s
            const earnedBadges = JSON.parse(localStorage.getItem('badges_earned')) || [];
            
            alert(`üìä VOS STATISTIQUES\n\n` +
                  `üíé P√©pites sauv√©es : ${likedIds.length}\n` +
                  `‚ùå Produits rejet√©s : ${dislikedIds.length}\n` +
                  `üì¶ Total √©valu√©s : ${total}\n` +
                  `‚ú® Taux d'acceptation : ${tauxAcceptation}%\n` +
                  `üîÑ Produits restants : ${filteredProducts.length}\n\n` +
                  `üí∞ √âconomies potentielles : ${totalEconomies.toFixed(2)}‚Ç¨\n` +
                  `üìä Prix moyen sauv√© : ${prixMoyen}‚Ç¨\n` +
                  `üéØ R√©duction moyenne : ${reductionMoy}%\n` +
                  `‚ù§Ô∏è Marque pr√©f√©r√©e : ${marquePref}\n\n` +
                  `üèÜ Badges d√©bloqu√©s : ${earnedBadges.length}/${Object.keys(badges).length}`);
        }

        function updateActiveCard() {
            document.querySelectorAll('.card').forEach((c, i) => c.classList.toggle('active', i === currentIndex));
        }

        function clearCache() {
            if (confirm("‚ö†Ô∏è Supprimer tous tes choix et r√©initialiser l'application ?")) {
                localStorage.clear();
                sessionStorage.clear();
                location.reload();
            }
        }

        // Gestion du scroll avec debounce
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const index = Math.round(window.scrollY / window.innerHeight);
                if (index !== currentIndex) { 
                    currentIndex = index; 
                    updateActiveCard(); 
                }
            }, 50);
        });

        // Gestion du swipe gauche/droite
        document.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
        });

        document.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].clientX;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > 100) {
                if (diff > 0) {
                    vote(currentIndex, 'nope');
                } else {
                    vote(currentIndex, 'like');
                }
            }
        });

        // Initialisation
        init();
    </script>
</body>
</html>
